<html>
    <head>
        <!-- linking the external files from font awesome and vuejs-->
        <link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <script src = "https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

        <!-- linking the lesson plan script-->
        <script src="lessons.js"></script>
        <style>
            body{
                margin:0;
            }
            #lessonBlock{
                background-color: black;
                color:white;
                padding:35px;
                width:15%;
                height:30%;
                margin:2%;
                border:3%;
            }
            #checkoutLessons{
                background-color:black;
                color:white;
                width:90%;
                padding:10px;
                margin:15px;
                border-radius: 8px 8px 8px 8px;
            }
            .error{
                color:red;
            }
        </style>

    </head>
    <body>

        <!-- Container Div-->
        <div id="lessonplanapp">
            <!-- Shoppping Cart Button -->
            <div>
                <button v-if="cartAggregate > 0" v-on:click="showCheckout()">
                    <!-- create logic to switch between checkout and lesson plan? -->
                    {{cartAggregate}} Checkout
                </button>
                <button v-else disabled>
                    <!-- create logic to switch between checkout and lesson plan? -->
                    {{cartAggregate}} Checkout
                </button>

            </div>


            <!-- Main Body -->
            <!-- Lesson Plans Division-->
            <div v-if="checkoutLogic" id="lessonDisplayDiv">

                <!-- Page Subtile -->
                <div><span style="font-weight: bold; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; font-size: x-large;" v-text="lessonsub"></span></div>

                <!-- Sorting/order Buttons -->
                <div name="sorting_options">
                    <select v-model="type">
                        <option disabled value="">Type</option>
                        <option v-for="type in types" v-bind:value="type"> {{type}}</option>
                    </select>

                    <input type="radio" value="true" v-model="ascending" default>
                    <label for="asc">Ascending</label>
                    <input type="radio" value="false" v-model="ascending">
                    <label for="desc">Descending</label>

                </div> 

                <!-- Search section -->
                <div>   
                    <br>
                    Search <input type="text" v-model="searchText"> 
                </div>

                <!-- ||||||||||| ADD font awesome icon  ||||||||||| -->
                <!-- Displaying Lessons individually -->
                <div id="lessonBlock" v-for="lesson in sortlessons" style="display:inline-block;">
                    <div v-if="lesson.showLesson">
                        <!-- lesson information -->
                        <h2 v-text="lesson.Subject"></h2>
                        <img style="width:50px;height:50px" v-bind:src="lesson.image">
                        <h4 v-text="lesson.Location"></h4>
                        <h4 v-text="lesson.price"></h4>

                        <!-- Cart Button -->
                        <button v-if="canAddTocart(lesson)" v-on:click="addtoCart(lesson)">
                            Add To Cart
                        </button>
                        <button v-else disabled>
                            Add To Cart
                        </button>

                        <!-- product count message-->
                        <span v-if="canAddTocart(lesson) == false ">
                            All Spaces Booked!
                        </span>
                        <!-- only less than 3 left -->
                        <span v-else-if="lesson.spaces - quantityAgg(lesson) <= 3">Only {{lesson.spaces}} Spaces Left! </span>
                    </div>
                </div>

            </div>

            <!-- Checkout and Shopping Cart Division -->
            <div id="cartDisplayDiv" v-else>
                <!-- Page Subtile -->
                <div><span style="font-weight: bold; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; font-size: x-large;" v-text="checkoutsub"></span></div>

                <!-- Lesson list of added lessons -->
                <div v-for="item in cart" id="checkoutLessons">
                    <!-- Lesson Details displayed -->

                    <span v-text="item.Subject"></span>
                    <span style="margin-left:200px;"> Location: <span v-text="item.Location"></span></span>
                    <div>
                        <span>Price Per Lesson: <span v-text = "item.price"></span></span>
                        <span style="margin-left:200px"> Spaces Chosen: <span v-text="item.quantity"></span></span>
                    </div>

                    <!-- Removal Button -->
                    <button v-on:click="remove(item)">
                        Remove a Space
                    </button>
                </div>

                <!-- Checkout Details of Customer -->
                <div name="checkoutSection" style="margin:20px;border:20px;">
                    <span >Full Name : <input type="text" v-if="cartAggregate <= 0" disabled> <input v-else type="text" v-model="checkoutDetails.fullName" id="checkoutName"></span>
                    <span>Phone Number : <input type="text" v-if="cartAggregate <= 0" disabled><input v-else type="text" v-model="checkoutDetails.phone" id="checkoutNumber"></span>


                    <!-- enable checkout if both full name and phone number are entered without errors, else disable-->
                    <button v-if="enableCheckout" v-on:click="checkoutConfirm"> Checkout </button> 
                    <button v-else disabled> Checkout </button>

                    <!-- display errors for user information -->
                    <span class="error" v-if="checkoutNameErrs"> please enter a valid name </span> <span v-else></span>
                    <span class="error" v-if="checkoutPhoneErrs"> please enter a valid phone number </span> <span v-else></span>

                </div>


            </div>

        </div>


        <!-- Vuejs Script -->
        <script type="text/javascript">
            var webstore = new Vue({
                el:'#lessonplanapp',
                data:{
                    lessonsub: 'Browse Our Lesson Catalogue',
                    lessons:lessons,
                    checkoutLogic: true,
                    ascending: true,
                    type:'',
                    searchText:'',
                    types:['Subject','Location','price'],
                    cart:[],
                    checkoutDetails:{
                        fullName: '',
                        phone:''
                    },
                    checkoutsub: 'Your Shopping Cart'

                },
                methods:{
                    canAddTocart: function(course) {
                        if (course.spaces > 0){
                            return true;
                        }
                        else {
                            return false;
                        }
                    },

                    addtoCart: function(course){

                        let lessonIncart = this.cart.find(i => i.id == course.id);
                        if (lessonIncart){
                            lessonIncart.quantity++;
                            course.spaces = course.spaces - 1;

                        }
                        else {
                            this.cart.push(course);
                            course.quantity++;
                            course.spaces = course.spaces - 1;
                        }
                    },

                    showCheckout: function() {
                        this.checkoutLogic ? this.checkoutLogic = false : this.checkoutLogic = true;
                    },

                    remove: function(course){
                        //if there's 1 quantity, then remove quantity from cart
                        if (course.quantity == 1 ){
                            this.cart.splice(this.cart.indexOf(course),1);
                        }

                        course.quantity = course.quantity - 1;
                        course.spaces = course.spaces + 1;

                    },
                    quantityAgg : function(course){
                        return course.quantity;
                    },
                    checkoutConfirm : function (){
                        alert("Order Has Been placed for " + this.checkoutDetails.fullName +". Thank you!");

                        //reset cart and refresh the page
                        this.cart.splice(0, this.cart.length);
                        document.location.reload();

                    }
                },
                computed:{
                    cartAggregate(){
                        
                        let itemcounter = 0;

                        if (this.cart.length > 0){
                            for (let i = 0; i < this.cart.length; i++){
                                itemcounter += this.cart[i].quantity;
                            }
                        }
                        return itemcounter;
                    },
                    sortlessons(){
                        let type = this.type;
                        let search = this.searchText;
                        

                        function compare(a,b){
                            if (a[type] > b[type]){
                                return 1;
                            }
                            else if (a[type] < b[type]){
                                return -1;
                            }
                            else {
                                return 0;
                            }
                        }

                        if (search.length <= 0){
                            return this.lessons.sort(compare);
                        }
                        else if( search.length > 0){
                            search = search.toLowerCase();
                            return this.lessons.filter((lesson)=>{
                                let subject = lesson.Subject.toLowerCase();
                                let location = lesson.Location.toLowerCase();

                                let subResult = subject.match(search);
                                let locResult = location.match(search);

                                if (subResult || locResult){
                                    return true;
                                }
                                else {
                                    return false;
                                }

                            })
                        }



                    },
                    checkoutNameErrs(){
                        //check all conditions, if no errors exist, return false. else true;
                        let name = this.checkoutDetails.fullName;
                        let pattern = /^[a-zA-Z ]*$/;
                        //check if name passes express test
                        if (!pattern.test(name)){
                            return true;
                        }
                        else {
                            return false;
                        }

                    },
                    checkoutPhoneErrs(){
                        //Same as checking errors with name, but with numbers only
                        let phone = this.checkoutDetails.phone;
                        let pattern = /^([0-9]*)$/;

                        // check if pattern passes the expression test
                        if (!pattern.test(phone)){
                            return true;
                        }
                        else {
                            return false;
                        }

                        return false;
                    },
                    enableCheckout(){
                        //check if all errors are resolved, thus allowing checkout
                        let name = this.checkoutDetails.fullName;
                        let Npattern = /^[a-zA-Z ]*$/;
                        let Ppattern = /^([0-9]*)$/;
                        let phone = this.checkoutDetails.phone;


                        if (this.cart.length > 0 && Npattern.test(name) && Ppattern.test(phone) && name.length > 2 && phone.length > 2){
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                }
            })
        </script>


    </body>
</html>